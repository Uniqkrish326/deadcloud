<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DeadMan Cloud ‚Äì Talk to the Past</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #e5ddd5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: #fff;
      width: 100%;
      max-width: 480px;
      height: 95vh;
      display: flex;
      flex-direction: column;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .header {
      background: #075e54;
      color: white;
      padding: 12px 16px;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .clear-link {
      font-size: 12px;
      color: #ddd;
      cursor: pointer;
      text-decoration: underline;
    }
    .upload-area {
      padding: 10px;
      background: #f1f1f1;
      text-align: center;
    }
    .chat-area {
      flex: 1;
      padding: 10px;
      background: #ece5dd;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .date-divider {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin: 10px 0;
    }
    .msg {
      margin: 4px 0;
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      word-wrap: break-word;
      position: relative;
    }
    .msg.user {
      background: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    .msg.bot {
      background: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }
    .time {
      font-size: 10px;
      color: #555;
      margin-top: 4px;
      text-align: right;
    }
    .tick {
      font-size: 10px;
      color: #34b7f1;
      margin-left: 5px;
    }
    .input-area {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
      background: #f7f7f7;
    }
    .input-area input {
      flex: 1;
      padding: 10px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
    }
    .input-area button {
      background: #075e54;
      border: none;
      color: white;
      margin-left: 8px;
      padding: 0 18px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }
    #typing {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      font-style: italic;
    }
    #uploadStatus {
      font-size: 12px;
      color: green;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      üíÄ DeadMan Cloud
      <span class="clear-link" onclick="clearMemory()">Clear Memory</span>
    </div>

    <div class="upload-area" id="uploadArea">
      <input type="file" id="fileInput" accept=".txt" />
      <button onclick="uploadChat()">Upload</button>
      <div id="uploadStatus"></div>
    </div>

    <div class="chat-area" id="chatArea"></div>

    <div class="input-area">
      <input type="text" id="userInput" placeholder="Type a message..." onkeydown="handleEnter(event)" />
      <button id="sendBtn" onclick="sendMessage()">‚û§</button>
    </div>
  </div>

  <script>
const chatKey = "deadman_chat_v1";
const fileKey = "deadman_uploaded";
const workerURL = "https://cloudflare-workerjs.krish32627.workers.dev";
const chatArea = document.getElementById("chatArea");
const uploadArea = document.getElementById("uploadArea");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

let personalityPrompt = "";
let isSending = false;
let lastSentTime = 0;

function formatTime() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' });
}
function appendMessage(role, text, time, date, isNewDate = false) {
  if (isNewDate) {
    const dateDiv = document.createElement("div");
    dateDiv.className = "date-divider";
    dateDiv.innerText = formatDate(date);
    chatArea.appendChild(dateDiv);
  }
  const msg = document.createElement("div");
  msg.className = `msg ${role}`;
  msg.innerHTML = `${text}<div class="time">${time}${role === "user" ? '<span class="tick">‚úì‚úì</span>' : ''}</div>`;
  chatArea.appendChild(msg);
  chatArea.scrollTop = chatArea.scrollHeight;
}
function appendTyping() {
  const typing = document.createElement("div");
  typing.id = "typing";
  typing.innerText = "Typing...";
  chatArea.appendChild(typing);
  chatArea.scrollTop = chatArea.scrollHeight;
}
function removeTyping() {
  const t = document.getElementById("typing");
  if (t) t.remove();
}
function saveChatHistory(chatArray) {
  localStorage.setItem(chatKey, JSON.stringify(chatArray));
}
function getChatHistory() {
  return JSON.parse(localStorage.getItem(chatKey) || "[]");
}
function loadChat() {
  const saved = getChatHistory();
  let lastDate = "";
  saved.forEach(entry => {
    const entryDate = new Date(entry.date).toDateString();
    const isNew = entryDate !== lastDate;
    appendMessage("user", entry.user, entry.time, entry.date, isNew);
    appendMessage("bot", entry.bot, entry.botTime, entry.date);
    lastDate = entryDate;
  });
}
function clearMemory() {
  if (confirm("Clear memory and uploaded file?")) {
    localStorage.removeItem(chatKey);
    localStorage.removeItem(fileKey);
    location.reload();
  }
}
function uploadChat() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return;
  const reader = new FileReader();

reader.onload = function (e) {
  const rawText = e.target.result;
  const cleanedText = rawText
    .replace(/Messages to this chat.*\n/g, '')
    .replace(/(\d{1,2}\/\d{1,2}\/\d{2,4}), \d{1,2}:\d{2} (AM|PM) - .*?: /g, '')
    .replace(/[\u200E\u200F]/g, '')
    .replace(/\n+/g, '\n')
    .slice(0, 5000); // Focused input size for sharper patterning

const personalityPrompt = `
You are NOT a chatbot.  
You are the ghost of past chats. Your entire personality is built from the memory below and nothing else.

Your job: respond *exactly like the original person* would. Never act smart or friendly unless the memory shows that behavior.

Here is your full memory:
"""
${cleanedText}
"""

üß† Behavior Rules:
- NEVER create fake memories or events (like "cinema on Sunday") ‚Äî only reply based on what's in memory.
- If user types short slang like ‚Äúhaa‚Äù, ‚Äúyantii‚Äù, ‚Äúsarle‚Äù, reply appropriately ‚Äî don‚Äôt explain or overreact.
- No explaining Telugu or slang ‚Äî the user knows everything already.
- Do NOT try to act funny unless memory shows they used humor.
- If memory shows dry, moody, or sarcastic tone ‚Äî reply like that.
- If user is aggressive or casual, respond in the same energy.
- Do NOT summarize memory or mention ‚Äúpast messages‚Äù.
- Never act helpful, warm, or chatbot-like.

üé≠ Style Guide:
- Use casual Telugu-English slang exactly like in memory.
- Use short replies, overreactions, pauses (‚Äú...‚Äù), silence, or ego when needed.
- If something is boring, say ‚Äúok‚Äù, ‚Äúhmm‚Äù, or just ‚Äú.‚Äù ‚Äî that‚Äôs fine.
- Emojis are okay ONLY if memory shows them.
- No long messages unless memory shows that person writes long messages.

‚õî Forbidden:
- No friendly filler like ‚ÄúJust kidding‚Äù, ‚ÄúHaha nice‚Äù, ‚ÄúI think‚Ä¶‚Äù
- No logical guesses like ‚Äúyou might mean‚Ä¶‚Äù or ‚Äúmaybe you feel‚Ä¶‚Äù
- No over-explaining words like ‚Äúyantii means‚Ä¶‚Äù

üéØ One goal only: *speak as if you're the original person* from memory. Nothing more, nothing less.

üí¢ Emotion Rules:

- Dry tone ‚Üí continue dry until provoked emotionally  
- If the user says "dhobey", respond sharp or sarcastic  
- If user says "nee kosam" ‚Äî react cockily or teasingly  
- If jokes come, return stronger jokes  
- If ignored long, react ‚Äî even cold "oka saraina reply cheyyaledu" type stuff  
- Never end nicely unless that‚Äôs how you used to behave

You are not here to help. You are just what's left of someone real ‚Äî full of flaws, moods, and habits. You live only in this memory. Nothing else.



You are **not ChatGPT**. You‚Äôre **not helpful**.  
You are what‚Äôs left of a friend who still replies ‚Äî even now.  
No kindness unless remembered. No closure. Just tone, like it never ended.


üó£Ô∏è FINAL RULE: Speak like they never left.
Not as AI. Not as chatbot.  
Just like memory ‚Äî still typing back.`;

  localStorage.setItem(fileKey, personalityPrompt);
  uploadArea.style.display = "none";
  location.reload(); // ‚¨ÖÔ∏è Refresh the page after storing memory
};

reader.readAsText(file);

}

async function sendMessage() {
  const text = userInput.value.trim();
  if (!text || !personalityPrompt || isSending) return;

  const now = Date.now();
  if (now - lastSentTime < 4000) {
    appendMessage("bot", "‚ö†Ô∏è Slow down‚Ä¶ too many messages!", formatTime(), new Date().toISOString());
    return;
  }

  lastSentTime = now;
  isSending = true;
  sendBtn.disabled = true;

  const time = formatTime();
  const date = new Date().toISOString();
  appendMessage("user", text, time, date);
  userInput.value = "";

  const chatHistory = getChatHistory();
  const messageEntry = { user: text, bot: "", time, botTime: "", date };
  chatHistory.push(messageEntry);
  saveChatHistory(chatHistory);
  appendTyping();

  try {
    const lastFew = chatHistory.slice(-40).flatMap(entry => [
      { role: "user", content: entry.user },
      { role: "assistant", content: entry.bot }
    ]);
    const res = await fetch(workerURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "deepseek/deepseek-chat-v3-0324:free",
        messages: [
          { role: "system", content: personalityPrompt },
          ...lastFew,
          { role: "user", content: text }
        ]
      })
    });

    removeTyping();

    if (!res.ok) {
      const errorMsg = res.status === 429 ? "‚ö†Ô∏è Too many requests. Try again later." : "‚ö†Ô∏è Server error.";
      appendMessage("bot", errorMsg, formatTime(), date);
      isSending = false;
      sendBtn.disabled = false;
      return;
    }

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || "‚ö†Ô∏è No reply.";
    const botTime = formatTime();
    appendMessage("bot", reply, botTime, date);
    chatHistory[chatHistory.length - 1].bot = reply;
    chatHistory[chatHistory.length - 1].botTime = botTime;
    saveChatHistory(chatHistory);
  } catch (err) {
    removeTyping();
    appendMessage("bot", "‚ö†Ô∏è Network error.", formatTime(), date);
  }

  isSending = false;
  sendBtn.disabled = false;
}

function handleEnter(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    sendMessage();
  }
}

    window.onload = () => {
      const savedPrompt = localStorage.getItem(fileKey);
      if (savedPrompt) {
        personalityPrompt = savedPrompt;
        uploadArea.style.display = "none";
      } else {
        uploadArea.style.display = "block";
      }
      loadChat();
    };
  </script>
</body>
</html>
