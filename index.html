<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DeadMan Cloud â€“ Talk to the Past</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #e5ddd5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: #fff;
      width: 100%;
      max-width: 480px;
      height: 95vh;
      display: flex;
      flex-direction: column;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .header {
      background: #075e54;
      color: white;
      padding: 12px 16px;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .clear-link {
      font-size: 12px;
      color: #ddd;
      cursor: pointer;
      text-decoration: underline;
    }
    .upload-area {
      padding: 10px;
      background: #f1f1f1;
      text-align: center;
      display: none;
    }
    .chat-area {
      flex: 1;
      padding: 10px;
      background: #ece5dd;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .date-divider {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin: 10px 0;
    }
    .msg {
      margin: 4px 0;
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      position: relative;
      word-wrap: break-word;
      display: inline-block;
    }
    .msg.user {
      background: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    .msg.bot {
      background: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 0;
    }
    .time {
      font-size: 10px;
      color: #555;
      margin-top: 4px;
      text-align: right;
    }
    .tick {
      font-size: 10px;
      color: #34b7f1;
      margin-left: 5px;
    }
    .input-area {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
      background: #f7f7f7;
    }
    .input-area input {
      flex: 1;
      padding: 10px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
    }
    .input-area button {
      background: #075e54;
      border: none;
      color: white;
      margin-left: 8px;
      padding: 0 18px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      ðŸ’€ DeadMan Cloud
      <span class="clear-link" onclick="confirmClear()">Clear Memory</span>
    </div>

    <div class="upload-area" id="uploadArea">
      <input type="file" id="fileInput" accept=".txt" />
      <button onclick="uploadChat()">Upload</button>
    </div>

    <div class="chat-area" id="chatArea"></div>

    <div class="input-area">
      <input type="text" id="userInput" placeholder="Type a message..." onkeydown="handleEnter(event)" />
      <button onclick="sendMessage()">âž¤</button>
    </div>
  </div>

  <script>
    let personalityPrompt = "";
    const API_KEY = "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"; // Replace with your key
    const chatKey = "deadman_chat_v1";
    const fileKey = "deadman_uploaded";

    const chatArea = document.getElementById("chatArea");
    const uploadArea = document.getElementById("uploadArea");

    function formatTime() {
      return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function appendMessage(role, text, time, date, isNewDate = false) {
      if (isNewDate) {
        const dateDiv = document.createElement("div");
        dateDiv.className = "date-divider";
        dateDiv.innerText = formatDate(date);
        chatArea.appendChild(dateDiv);
      }

      const msg = document.createElement("div");
      msg.className = `msg ${role}`;
      msg.innerHTML = `${text}<div class="time">${time}${role === "user" ? '<span class="tick">âœ“âœ“</span>' : ''}</div>`;
      chatArea.appendChild(msg);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function saveChatHistory(chatArray) {
      localStorage.setItem(chatKey, JSON.stringify(chatArray));
    }

    function getChatHistory() {
      return JSON.parse(localStorage.getItem(chatKey) || "[]");
    }

    function loadChat() {
      const saved = getChatHistory();
      let lastDate = "";
      saved.forEach(entry => {
        const entryDate = new Date(entry.date).toDateString();
        const isNew = entryDate !== lastDate;
        appendMessage("user", entry.user, entry.time, entry.date, isNew);
        appendMessage("bot", entry.bot, entry.botTime, entry.date, false);
        lastDate = entryDate;
      });
    }

    function confirmClear() {
      if (confirm("Are you sure you want to clear the memory? This will erase uploaded file and chat.")) {
        localStorage.removeItem(chatKey);
        localStorage.removeItem(fileKey);
        location.reload();
      }
    }

    function uploadChat() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const rawText = e.target.result;
        const cleanedText = rawText
          .replace(/Messages to this chat.*\n/g, '')
          .replace(/(\d{1,2}\/\d{1,2}\/\d{2,4}), \d{1,2}:\d{2} (AM|PM) - .*?: /g, '')
          .slice(0, 2000);

        personalityPrompt = `
You are NOT an AI. You are the person who sent these WhatsApp messages.
You only know whatâ€™s in the messages. You cannot imagine, guess, or invent new things.

Respond in the same language and tone used in the messages (Telugu, English, mix, slang etc.).
Keep it short, casual, human â€” just how you normally talk to a friend.
Avoid emojis overload, overacting, or dramatic tones. Do not be super smart.
Only use style from the messages.
Messages:
"""
${cleanedText}
"""`;

        localStorage.setItem(fileKey, personalityPrompt);
        uploadArea.style.display = "none";
      };
      reader.readAsText(file);
    }

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const userText = input.value.trim();
      if (!userText || !personalityPrompt) return;

      const time = formatTime();
      const date = new Date().toISOString();
      appendMessage("user", userText, time, date);

      input.value = "";

      const chatHistory = getChatHistory();

      try {
        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model: "deepseek/deepseek-chat",
            messages: [
              { role: "system", content: personalityPrompt },
              { role: "user", content: userText }
            ]
          })
        });

        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content || "âš ï¸ No response.";
        const botTime = formatTime();
        appendMessage("bot", reply, botTime, date);

        chatHistory.push({ user: userText, bot: reply, time, botTime, date });
        saveChatHistory(chatHistory);

      } catch (err) {
        console.error("Error:", err);
        appendMessage("bot", "âš ï¸ Error reaching server.", formatTime(), date);
      }
    }

    function handleEnter(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    }

    // Init
    window.onload = () => {
      const savedPrompt = localStorage.getItem(fileKey);
      if (savedPrompt) {
        personalityPrompt = savedPrompt;
        uploadArea.style.display = "none";
      } else {
        uploadArea.style.display = "block";
      }
      loadChat();
    };
  </script>
</body>
</html>

